<!DOCTYPE html>












  


<html class="theme-next gemini use-motion" lang="zh-CN">
<head><meta name="generator" content="Hexo 3.8.0">
  <!-- hexo-inject:begin --><!-- hexo-inject:end --><meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">




  
  
    
    
  <script src="/lib/pace/pace.min.js?v=1.0.2"></script>
  <link rel="stylesheet" href="/lib/pace/pace-theme-minimal.min.css?v=1.0.2">



  
  
  <link rel="stylesheet" href="/lib/Han/dist/han.min.css?v=3.3">



  <meta http-equiv="Cache-Control" content="no-transform">
  <meta http-equiv="Cache-Control" content="no-siteapp">











  
  
  <link rel="stylesheet" href="/lib/fancybox/source/jquery.fancybox.css">







<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2">

<link rel="stylesheet" href="/css/main.css?v=7.1.1">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=7.1.1">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/cat_32px_1165145_easyicon.net.ico?v=7.1.1">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/cat_16px_1165145_easyicon.net.ico?v=7.1.1">


  <link rel="mask-icon" href="/images/logo.svg?v=7.1.1" color="#222">







<script id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Gemini',
    version: '7.1.1',
    sidebar: {"position":"left","display":"post","offset":12,"onmobile":false,"dimmer":false},
    back2top: true,
    back2top_sidebar: false,
    fancybox: true,
    fastclick: true,
    lazyload: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '5HERDWLKZV',
      apiKey: '7876dff207d78e6df0721656b26ee0af',
      indexName: 'hexo-algolia',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  




  <meta name="description" content="In this post you will learn how to use a micro framework called Spark to build a RESTful backend. The RESTful backend is consumed by a single page web application using AngularJS and MongoDB for data">
<meta property="og:type" content="article">
<meta property="og:title" content="Mr.Miaow Blog">
<meta property="og:url" content="http://miaopei.github.io/2019/06/14/practical-programming-books/src/Developing-Single-Page-Web-Applications/index.html">
<meta property="og:site_name" content="Mr.Miaow Blog">
<meta property="og:description" content="In this post you will learn how to use a micro framework called Spark to build a RESTful backend. The RESTful backend is consumed by a single page web application using AngularJS and MongoDB for data">
<meta property="og:locale" content="zh-CN">
<meta property="og:image" content="http://miaopei.github.io/wp-content/uploads/imported/spark-blog-list-all-todos.png">
<meta property="og:image" content="http://miaopei.github.io/wp-content/uploads/imported/spark-blog-mark-todo-done.png">
<meta property="og:image" content="http://miaopei.github.io/wp-content/uploads/imported/spark-blog-create-new-todo.png">
<meta property="og:updated_time" content="2019-06-14T02:52:59.697Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Mr.Miaow Blog">
<meta name="twitter:description" content="In this post you will learn how to use a micro framework called Spark to build a RESTful backend. The RESTful backend is consumed by a single page web application using AngularJS and MongoDB for data">
<meta name="twitter:image" content="http://miaopei.github.io/wp-content/uploads/imported/spark-blog-list-all-todos.png">



  <link rel="alternate" href="/atom.xml" title="Mr.Miaow Blog" type="application/atom+xml">



  
  
  <link rel="canonical" href="http://miaopei.github.io/2019/06/14/practical-programming-books/src/Developing-Single-Page-Web-Applications/">



<script id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>

  <title> | Mr.Miaow Blog</title>
  












  <noscript>
  <style>
  .use-motion .motion-element,
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-title { opacity: initial; }

  .use-motion .logo,
  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript><!-- hexo-inject:begin --><!-- hexo-inject:end -->

</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-CN">

  
  
    
  

  <!-- hexo-inject:begin --><!-- hexo-inject:end --><div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Mr.Miaow Blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
    
      
        <h1 class="site-subtitle" itemprop="description">天道酬勤，地道酬善，人道酬誠，商道酬信，業道酬精</h1>
      
    
    
  </div>

  <div class="site-nav-toggle">
    <button aria-label="切换导航栏">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>



<nav class="site-nav">
  
    <ul id="menu" class="menu">
      
        
        
        
          
          <li class="menu-item menu-item-home">

    
    
    
      
    

    

    <a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i> <br>首页</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-tags">

    
    
    
      
    

    

    <a href="/tags/" rel="section"><i class="menu-item-icon fa fa-fw fa-tags"></i> <br>标签</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-categories">

    
    
    
      
    

    

    <a href="/categories/" rel="section"><i class="menu-item-icon fa fa-fw fa-th"></i> <br>分类</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-archives">

    
    
    
      
    

    

    <a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i> <br>归档</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-about">

    
    
    
      
    

    

    <a href="/about/" rel="section"><i class="menu-item-icon fa fa-fw fa-user"></i> <br>关于</a>

  </li>

      
      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br>搜索</a>
        </li>
      
    </ul>
  

  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off" placeholder="搜索..." spellcheck="false" type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



  



</div>
    </header>

    


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          
            

          
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  
    <div class="reading-progress-bar"></div>
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://miaopei.github.io/2019/06/14/practical-programming-books/src/Developing-Single-Page-Web-Applications/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="苗沛">
      <meta itemprop="description" content="滴水石穿，不是力量大，而是功夫深!">
      <meta itemprop="image" content="http://wx4.sinaimg.cn/orj360/e9d04169ly1fde7jy4bquj20ek0hf7gh.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Mr.Miaow Blog">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">

              
            
          </h2>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2019-06-14 10:52:59" itemprop="dateCreated datePublished" datetime="2019-06-14T10:52:59+08:00">2019-06-14</time>
            

            
          </span>

          

          
            
            
          

          
          

          

          
            <div class="post-symbolscount">
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">本文字数：</span>
                
                <span title="本文字数">0</span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">1 分钟</span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body han-init-context" itemprop="articleBody">

      
      

      
         <p>In this post you will learn how to use a micro framework called <span class="exturl" data-url="aHR0cDovL3d3dy5zcGFya2phdmEuY29tLw==" title="http://www.sparkjava.com/">Spark<i class="fa fa-external-link"></i></span> to build a RESTful backend. The RESTful backend is consumed by a single page web application using AngularJS and MongoDB for data storage. I&#8217;ll also show you how to run Java 8 on OpenShift.</p>
<h2>Application Use Case</h2>
<p>You will develop a todo application which allows users to create and list todo items. The application will do the following:</p>
<ul>
<li>When a user goes to the &#8216;/&#8217; url of the application, they will see a list of all todos stored in the application database. Behind the curtain, AngularJS makes a REST(/api/v1/todos) call to fetch all the todo items.</li>
</ul>
<p><img style="display: block; margin-left: auto; margin-right: auto;" src="/wp-content/uploads/imported/spark-blog-list-all-todos.png" alt="TodoApp List All Todos" width="600"></p>
<ul>
<li>When a user clicks on the checkbox then a todo is marked done. AngularJS makes a PUT request and update the todo item.</li>
</ul>
<p><img style="display: block; margin-left: auto; margin-right: auto;" src="/wp-content/uploads/imported/spark-blog-mark-todo-done.png" alt="TodoApp" width="600"></p>
<ul>
<li>Finally, a user can add a new todo by navigating to http://todoapp-shekharblogs.rhcloud.com/#/create. This makes a POST call to the RESTful backend and saves the todo in the MongoDB datastore.</li>
</ul>
<p><img style="display: block; margin-left: auto; margin-right: auto;" src="/wp-content/uploads/imported/spark-blog-create-new-todo.png" alt="TodoApp Add New Todo" width="600"></p>
<h2>What is Spark?</h2>
<p>Spark is a Java based microframework for building web applications with minimum fuss. It is inspired by a framework written in Ruby called Sinatra. It has a minimalist core providing all the essential features required to build a web application quickly with little code.</p>
<h2>Prerequisite</h2>
<p>To build the sample application developed in this blog, you would need the following on your machine.</p>
<ol>
<li>Download and install <span class="exturl" data-url="aHR0cHM6Ly9qZGs4LmphdmEubmV0L2Rvd25sb2FkLmh0bWw=" title="https://jdk8.java.net/download.html">JDK 8<i class="fa fa-external-link"></i></span></li>
<li>Download and install Eclipse or any other IDE. Eclipse users make sure you have <span class="exturl" data-url="aHR0cHM6Ly93d3cuZWNsaXBzZS5vcmcvZG93bmxvYWRzL2luZGV4LWphdmE4LnBocA==" title="https://www.eclipse.org/downloads/index-java8.php">Eclipse with Java 8 support<i class="fa fa-external-link"></i></span>.</li>
<li>Download and install <span class="exturl" data-url="aHR0cDovL21hdmVuLmFwYWNoZS5vcmcvZG93bmxvYWQuY2dp" title="http://maven.apache.org/download.cgi">Apache Maven<i class="fa fa-external-link"></i></span></li>
<li>Download and install <span class="exturl" data-url="aHR0cDovL3d3dy5tb25nb2RiLm9yZy9kb3dubG9hZHM=" title="http://www.mongodb.org/downloads">MongoDB<i class="fa fa-external-link"></i></span></li>
</ol>
<h2>Github Repository</h2>
<p>The code for today&#8217;s demo application is available on <span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL3NoZWtoYXJndWxhdGkvdG9kb2FwcC1zcGFyaw==" title="https://github.com/shekhargulati/todoapp-spark">github: todoapp-spark<i class="fa fa-external-link"></i></span>.</p>
<h2>Step 1: Create a Maven project</h2>
<p>Open a new command-line terminal and navigate to the location where you want to create the project. Execute the command shown below to generate the template application.</p>
<div class="geshifilter">
<pre class="text geshifilter-text" style="font-family: monospace;">$ mvn archetype:generate -DgroupId=com.todoapp -DartifactId=todoapp -DarchetypeArtifactId=maven-archetype-quickstart -DinteractiveMode=false</pre>
</div>
<h2>Step 2: Update the maven project to use Java 8</h2>
<p>Import the project into your IDE and replace the pom.xml with the one shown below.</p>
<div class="geshifilter">
<pre class="text geshifilter-text" style="font-family: monospace;">&lt;project xmlns="http://maven.apache.org/POM/4.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/maven-v4_0_0.xsd"&gt;
    &lt;modelVersion&gt;4.0.0&lt;/modelVersion&gt;
    &lt;groupId&gt;com.todoapp&lt;/groupId&gt;
    &lt;artifactId&gt;todoapp&lt;/artifactId&gt;
    &lt;packaging&gt;jar&lt;/packaging&gt;
    &lt;version&gt;1.0-SNAPSHOT&lt;/version&gt;
    &lt;name&gt;todoapp&lt;/name&gt;
    &lt;url&gt;http://maven.apache.org&lt;/url&gt;

<pre><code>&amp;lt;properties&amp;gt;
    &amp;lt;maven.compiler.source&amp;gt;1.8&amp;lt;/maven.compiler.source&amp;gt;
    &amp;lt;maven.compiler.target&amp;gt;1.8&amp;lt;/maven.compiler.target&amp;gt;
&amp;lt;/properties&amp;gt;

&amp;lt;dependencies&amp;gt;

&amp;lt;/dependencies&amp;gt;</code></pre><p>&lt;/project&gt;</p></pre><p></p>
</div>
<p>In the pom.xml shown above, we changed the following:</p>
<ol>
<li>You updated Maven to use Java 8 by defining maven.compiler.source and maven.compiler.target properties.</li>
<li>You removed the JUnit dependency from the original pom.xml file.</li>
</ol>
<p>Delete App.java and AppTest.java files as we don&#8217;t need them.</p>
<h2>Step 3: Add Spark and other dependencies</h2>
<p>The application uses the Spark framework and a MongoDB database. So, update the dependencies section of pom.xml with the one shown below.</p>
<div class="geshifilter">
<pre class="text geshifilter-text" style="font-family: monospace;">&lt;dependencies&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;com.sparkjava&lt;/groupId&gt;
            &lt;artifactId&gt;spark-core&lt;/artifactId&gt;
            &lt;version&gt;2.0.0&lt;/version&gt;
        &lt;/dependency&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;org.slf4j&lt;/groupId&gt;
            &lt;artifactId&gt;slf4j-simple&lt;/artifactId&gt;
            &lt;version&gt;1.7.5&lt;/version&gt;
        &lt;/dependency&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;org.mongodb&lt;/groupId&gt;
            &lt;artifactId&gt;mongo-java-driver&lt;/artifactId&gt;
            &lt;version&gt;2.11.3&lt;/version&gt;
        &lt;/dependency&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;com.google.code.gson&lt;/groupId&gt;
            &lt;artifactId&gt;gson&lt;/artifactId&gt;
            &lt;version&gt;2.2.4&lt;/version&gt;
        &lt;/dependency&gt;
&lt;/dependencies&gt;</pre>
</div>
<p>Spark uses SLF4J for logging, so we added slf4j-simple binding in the dependencies. This is required to view the log and error messages. Also, we added the gson library as its used to convert objects to and from JSON.</p>
<h2>Step 4: Make Spark Say Hello World</h2>
<p>Create a new class called Bootstrap and add the following code to it.</p>
<div class="geshifilter">
<pre class="text geshifilter-text" style="font-family: monospace;">package com.todoapp;

<p>import spark.Request;<br>import spark.Response;<br>import spark.Route;</p>
<p>import static spark.Spark.*;</p>
<p>public class Bootstrap {</p>
<pre><code>public static void main(String[] args) {
    get(&quot;/&quot;, new Route() {
        @Override
        public Object handle(Request request, Response response) {
            return &quot;Hello World!!&quot;;
        }
    });
}</code></pre><p>}</p></pre><p></p>
</div>
<p>This code:</p>
<ol>
<li>Imports the required classes from the Spark library.</li>
<li>Creates a new class called Bootstrap and defines a main method.</li>
<li>Defines a route that tells Spark that when an HTTP GET request is made to &#8216;/&#8217;, return &#8220;Hello World&#8221;. You use Spark&#8217;s get() method to define the mapping from the URL to the callback.</li>
</ol>
<p>To see the application in action, run the main program using your IDE. The application will start the embedded Jetty server at http://0.0.0.0:4567. When you open this link in your web browser, you will see &#8220;Hello World!!&#8221;.</p>
<p>Take advantage of Java 8 lambda expressions to make your code more concise and clean. Spark is a modern Java web framework that takes advantage of Java 8 features.</p>
<div class="geshifilter">
<pre class="text geshifilter-text" style="font-family: monospace;">package com.todoapp;

<p>import spark.Request;<br>import spark.Response;<br>import spark.Route;</p>
<p>import static spark.Spark.*;</p>
<p>public class Bootstrap {</p>
<pre><code>public static void main(String[] args) {
    get(&quot;/&quot;, (request, response) -&amp;gt; &quot;Hello World&quot;);
}</code></pre><p>}</p></pre><p></p>
</div>
<h2>Step 5: Defining the Domain Model and Service class</h2>
<p>Our goal is an application that stores and manages ToDo items. Our simple ToDo class is shown below.</p>
<div class="geshifilter">
<pre class="text geshifilter-text" style="font-family: monospace;">package com.todoapp;

<p>import com.mongodb.BasicDBObject;<br>import com.mongodb.DBObject;<br>import org.bson.types.ObjectId;</p>
<p>import java.util.Date;</p>
<p>public class Todo {</p>
<pre><code>private String id;
private String title;
private boolean done;
private Date createdOn = new Date();

public Todo(BasicDBObject dbObject) {
    this.id = ((ObjectId) dbObject.get(&quot;_id&quot;)).toString();
    this.title = dbObject.getString(&quot;title&quot;);
    this.done = dbObject.getBoolean(&quot;done&quot;);
    this.createdOn = dbObject.getDate(&quot;createdOn&quot;);
}

public String getTitle() {
    return title;
}

public boolean isDone() {
    return done;
}

public Date getCreatedOn() {
    return createdOn;
}</code></pre><p>}</p></pre><p></p>
</div>
<p>Our TodoService class implement methods that use CRUD operations on the Todo object. It basically Creates, Reads, and Updates Todo documents stored in MongoDB.</p>
<div class="geshifilter">
<pre class="text geshifilter-text" style="font-family: monospace;">package com.todoapp;

<p>import com.google.gson.Gson;<br>import com.mongodb.*;<br>import org.bson.types.ObjectId;</p>
<p>import java.util.ArrayList;<br>import java.util.Collections;<br>import java.util.Date;<br>import java.util.List;</p>
<p>public class TodoService {</p>
<pre><code>private final DB db;
private final DBCollection collection;

public TodoService(DB db) {
    this.db = db;
    this.collection = db.getCollection(&quot;todos&quot;);
}

public List&amp;lt;Todo&amp;gt; findAll() {
    List&amp;lt;Todo&amp;gt; todos = new ArrayList&amp;lt;&amp;gt;();
    DBCursor dbObjects = collection.find();
    while (dbObjects.hasNext()) {
        DBObject dbObject = dbObjects.next();
        todos.add(new Todo((BasicDBObject) dbObject));
    }
    return todos;
}

public void createNewTodo(String body) {
    Todo todo = new Gson().fromJson(body, Todo.class);
    collection.insert(new BasicDBObject(&quot;title&quot;, todo.getTitle()).append(&quot;done&quot;, todo.isDone()).append(&quot;createdOn&quot;, new Date()));
}

public Todo find(String id) {
    return new Todo((BasicDBObject) collection.findOne(new BasicDBObject(&quot;_id&quot;, new ObjectId(id))));
}

public Todo update(String todoId, String body) {
    Todo todo = new Gson().fromJson(body, Todo.class);
    collection.update(new BasicDBObject(&quot;_id&quot;, new ObjectId(todoId)), new BasicDBObject(&quot;$set&quot;, new BasicDBObject(&quot;done&quot;, todo.isDone())));
    return this.find(todoId);
}</code></pre><p>}</p></pre><p></p>
</div>
<p>This code does the following:</p>
<ol>
<li>The TodoService class constructor receives the MongoDB database object and stores that in the instance variable. You use the db.getCollection() method to fetch the todos collection. All of the operation are done on the todos collection.</li>
<li>The findAll() method fetches all of the todo documents from the MongoDB database. The documents fetched from MongoDB are of the DBObject type. You iterated over the DBCursor object and converted the individual documents to Todo objects and then added them to a List. Finally, you returned the list of todos.</li>
<li>The createNewTodo() method receives a JSON string representing the Todo item. You used GSON to convert the JSON to a Todo object. Finally, you inserted the BasicDBObject into the todos collection.</li>
<li>The find() method finds the Todo item corresponding to a given id.</li>
<li>The update() method updates the Todo document for the given todo Id. It also updates the done field of the document.</li>
</ol>
<h2>Step 6: Creating the Resource class</h2>
<p>It is generally not a good idea to add all of the code to one class so we will move the application REST endpoints to another class. This new class is called TodoResource and exposes CRUD operations over Todo objects.</p>
<div class="geshifilter">
<pre class="text geshifilter-text" style="font-family: monospace;">package com.todoapp;

<p>import com.google.gson.Gson;<br>import spark.Request;<br>import spark.Response;<br>import spark.Route;</p>
<p>import java.util.HashMap;</p>
<p>import static spark.Spark.get;<br>import static spark.Spark.post;<br>import static spark.Spark.put;</p>
<p>public class TodoResource {</p>
<pre><code>private static final String API_CONTEXT = &quot;/api/v1&quot;;

private final TodoService todoService;

public TodoResource(TodoService todoService) {
    this.todoService = todoService;
    setupEndpoints();
}

private void setupEndpoints() {
    post(API_CONTEXT + &quot;/todos&quot;, &quot;application/json&quot;, (request, response) -&amp;gt; {
        todoService.createNewTodo(request.body());
        response.status(201);
        return response;
    }, new JsonTransformer());

    get(API_CONTEXT + &quot;/todos/:id&quot;, &quot;application/json&quot;, (request, response)

            -&amp;gt; todoService.find(request.params(&quot;:id&quot;)), new JsonTransformer());

    get(API_CONTEXT + &quot;/todos&quot;, &quot;application/json&quot;, (request, response)

            -&amp;gt; todoService.findAll(), new JsonTransformer());

    put(API_CONTEXT + &quot;/todos/:id&quot;, &quot;application/json&quot;, (request, response)

            -&amp;gt; todoService.update(request.params(&quot;:id&quot;), request.body()), new JsonTransformer());
}</code></pre><p>}</p></pre><p></p>
</div>
<p>The code shown above exposes the TodoService CRUD methods as REST API&#8217;s.</p>
<p>JsonTransformer in the code shown above is an implementation of Spark&#8217;s ResponseTransformer interface. It allows you to convert response objects to other formats like JSON.</p>
<div class="geshifilter">
<pre class="text geshifilter-text" style="font-family: monospace;">package com.todoapp;

<p>import com.google.gson.Gson;<br>import spark.Response;<br>import spark.ResponseTransformer;</p>
<p>import java.util.HashMap;</p>
<p>public class JsonTransformer implements ResponseTransformer {</p>
<pre><code>private Gson gson = new Gson();

@Override
public String render(Object model) {
    return gson.toJson(model);
}</code></pre><p>}</p></pre><p></p>
</div>
<h2>Step 7: Bootstrap the application</h2>
<p>Now we will write the entry point for our application. The Bootstrap class shown below configures all of the components. When you run this class as a Java application, it starts the Jetty server and start listening to requests.</p>
<div class="geshifilter">
<pre class="text geshifilter-text" style="font-family: monospace;">package com.todoapp;

<p>import com.mongodb.*;</p>
<p>import static spark.Spark.setIpAddress;<br>import static spark.Spark.setPort;<br>import static spark.SparkBase.staticFileLocation;</p>
<p>public class Bootstrap {<br>    private static final String IP_ADDRESS = System.getenv(“OPENSHIFT_DIY_IP”) != null ? System.getenv(“OPENSHIFT_DIY_IP”) : “localhost”;<br>    private static final int PORT = System.getenv(“OPENSHIFT_DIY_PORT”) != null ? Integer.parseInt(System.getenv(“OPENSHIFT_DIY_PORT”)) : 8080;</p>
<pre><code>public static void main(String[] args) throws Exception {
    setIpAddress(IP_ADDRESS);
    setPort(PORT);
    staticFileLocation(&quot;/public&quot;);
    new TodoResource(new TodoService(mongo()));
}

private static DB mongo() throws Exception {
    String host = System.getenv(&quot;OPENSHIFT_MONGODB_DB_HOST&quot;);
    if (host == null) {
        MongoClient mongoClient = new MongoClient(&quot;localhost&quot;);
        return mongoClient.getDB(&quot;todoapp&quot;);
    }
    int port = Integer.parseInt(System.getenv(&quot;OPENSHIFT_MONGODB_DB_PORT&quot;));
    String dbname = System.getenv(&quot;OPENSHIFT_APP_NAME&quot;);
    String username = System.getenv(&quot;OPENSHIFT_MONGODB_DB_USERNAME&quot;);
    String password = System.getenv(&quot;OPENSHIFT_MONGODB_DB_PASSWORD&quot;);
    MongoClientOptions mongoClientOptions = MongoClientOptions.builder().build();
    MongoClient mongoClient = new MongoClient(new ServerAddress(host, port), mongoClientOptions);
    mongoClient.setWriteConcern(WriteConcern.SAFE);
    DB db = mongoClient.getDB(dbname);
    if (db.authenticate(username, password.toCharArray())) {
        return db;
    } else {
        throw new RuntimeException(&quot;Not able to authenticate with MongoDB&quot;);
    }
}</code></pre><p>}</p></pre><p></p>
</div>
<h2>Step 8 : Setup AngularJS and Twitter Bootstrap</h2>
<p>Create a new directory with name <em>public</em> and place the javascript and css files in it. You can checkout the required directory structure from the <span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL3NoZWtoYXJndWxhdGkvdG9kb2FwcC1zcGFyay90cmVlL21hc3Rlci9zcmMvbWFpbi9yZXNvdXJjZXM=" title="https://github.com/shekhargulati/todoapp-spark/tree/master/src/main/resources">Github repository<i class="fa fa-external-link"></i></span>. Download the latest copy of <span class="exturl" data-url="aHR0cHM6Ly9hbmd1bGFyanMub3JnLw==" title="https://angularjs.org/">AngularJS<i class="fa fa-external-link"></i></span> and <span class="exturl" data-url="aHR0cDovL2dldGJvb3RzdHJhcC5jb20v" title="http://getbootstrap.com/">Bootstrap<i class="fa fa-external-link"></i></span> from their respective official websites, or you can copy the resources from this project <span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL3NoZWtoYXJndWxhdGkvdG9kb2FwcC1zcGFyay90cmVlL21hc3Rlci9zcmMvbWFpbi9yZXNvdXJjZXMvcHVibGlj" title="https://github.com/shekhargulati/todoapp-spark/tree/master/src/main/resources/public">github repository<i class="fa fa-external-link"></i></span>.</p>
<h2>Step 9: Create index.html</h2>
<p>Create a new file called index.html inside of the src/main/resources/public directory and place the following content into it.</p>
<div class="geshifilter">
<pre class="text geshifilter-text" style="font-family: monospace;">&lt;!DOCTYPE html&gt;
&lt;html ng-app="todoapp"&gt;
&lt;head&gt;
    &lt;title&gt;Todo App&lt;/title&gt;
    &lt;link rel="stylesheet" href="/css/bootstrap.css"&gt;
    &lt;link rel="stylesheet" href="/css/main.css"&gt;
&lt;/head&gt;
&lt;body&gt;
&lt;div class="navbar navbar-inverse"&gt;
    &lt;div class="container-fluid"&gt;
        &lt;div class="navbar-header"&gt;
            &lt;button type="button" class="navbar-toggle"&gt;
                &lt;span class="sr-only"&gt;Toggle navigation&lt;/span&gt;
                &lt;span class="icon-bar"&gt;&lt;/span&gt;
                &lt;span class="icon-bar"&gt;&lt;/span&gt;
                &lt;span class="icon-bar"&gt;&lt;/span&gt;
            &lt;/button&gt;
            &lt;a class="navbar-brand" href="/"&gt;TodoApp&lt;/a&gt;
        &lt;/div&gt;
    &lt;/div&gt;
&lt;/div&gt;

<p>&lt;div class=”container” ng-view=””&gt;</p>
<p>&lt;/div&gt;</p>
<p>&lt;script src=”/js/jquery.js”&gt;&lt;/script&gt;<br>&lt;script src=”/js/angular.js”&gt;&lt;/script&gt;<br>&lt;script src=”/js/angular-route.js”&gt;&lt;/script&gt;<br>&lt;script src=”/js/angular-cookies.js”&gt;&lt;/script&gt;<br>&lt;script src=”/js/angular-sanitize.js”&gt;&lt;/script&gt;<br>&lt;script src=”/js/angular-resource.js”&gt;&lt;/script&gt;</p>
<p>&lt;script src=”/scripts/app.js”&gt;&lt;/script&gt;<br>&lt;/body&gt;<br>&lt;/html&gt;</p></pre><p></p>
</div>
<p>In the html shown above:</p>
<ol>
<li>You imported all of the required libraries. Our application code is in /scripts/app.js. The app.js file will be created in step 10.</li>
<li>In Angular, you defined the scope of the project using the ng-app directive. You used ng-app on the html element but we can use it with any other element as well. Using the ng-app directive with html element means that AngularJS is available on the whole index.html. The ng-app directive can take a name. This name is the module name. I used todoapp as this application module name.</li>
<li>The last interesting thing in the index.html is the use of the ng-view directive. The ng-view directive renders the template corresponding to the current route inside index.html. So that everytime you navigate to a route only the ng-view portion changes.</li>
</ol>
<h2>Step 10: Write the Angular application</h2>
<p>The app.js houses all of the application specific JavaScript. All of the application routes are defined inside it. In the code shown below, we have defined two routes and each has a corresponding Angular controller.</p>
<div class="geshifilter">
<pre class="text geshifilter-text" style="font-family: monospace;">/**
 * Created by shekhargulati on 10/06/14.
 */

<p>var app = angular.module(‘todoapp’, [<br>    ‘ngCookies’,<br>    ‘ngResource’,<br>    ‘ngSanitize’,<br>    ‘ngRoute’<br>]);</p>
<p>app.config(function ($routeProvider) {<br>    $routeProvider.when(‘/‘, {<br>        templateUrl: ‘views/list.html’,<br>        controller: ‘ListCtrl’<br>    }).when(‘/create’, {<br>        templateUrl: ‘views/create.html’,<br>        controller: ‘CreateCtrl’<br>    }).otherwise({<br>        redirectTo: ‘/‘<br>    })<br>});</p>
<p>app.controller(‘ListCtrl’, function ($scope, $http) {<br>    $http.get(‘/api/v1/todos’).success(function (data) {<br>        $scope.todos = data;<br>    }).error(function (data, status) {<br>        console.log(‘Error ‘ + data)<br>    })</p>
<pre><code>$scope.todoStatusChanged = function (todo) {
    console.log(todo);
    $http.put(&apos;/api/v1/todos/&apos; + todo.id, todo).success(function (data) {
        console.log(&apos;status changed&apos;);
    }).error(function (data, status) {
        console.log(&apos;Error &apos; + data)
    })
}</code></pre><p>});</p>
<p>app.controller(‘CreateCtrl’, function ($scope, $http, $location) {<br>    $scope.todo = {<br>        done: false<br>    };</p>
<pre><code>$scope.createTodo = function () {
    console.log($scope.todo);
    $http.post(&apos;/api/v1/todos&apos;, $scope.todo).success(function (data) {
        $location.path(&apos;/&apos;);
    }).error(function (data, status) {
        console.log(&apos;Error &apos; + data)
    })
}</code></pre><p>});</p></pre><p></p>
</div>
<p>The code shown above does the following:</p>
<ol>
<li>First, it configures the Angular module named todoapp and defines all of it&#8217;s dependencies.</li>
<li>It defines the routes that this application will respond to.</li>
<li>When a user makes request to &#8216;/&#8217;, the ListCtrl will be invoked. The ListCtrl will make an HTTP GET request to &#8216;/api/v1/todos&#8217; to fetch all of the todo items. The todo items are put on the scope. The list.html uses the ng-repeat directive to iterate over all of the todo items and generate a table.</li>
<li>When a user clicks on the checkbox next to the item, the todoStatusChanged() function is invoked. This function makes an HTTP PUT request to update the todo item.</li>
<li>When a user makes a GET request to &#8216;/create&#8217;, create.html is rendered. The create.html renders a bootstrap form. The form HTML element uses the ng-submit directive. On form submit the createTodo function is invoked. The createTodo function makes an HTTP POST request to create a new todo item.</li>
</ol>
<p>You can find the respective views for different routes in the application&#8217;s <span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL3NoZWtoYXJndWxhdGkvdG9kb2FwcC1zcGFyay90cmVlL21hc3Rlci9zcmMvbWFpbi9yZXNvdXJjZXMvcHVibGljL3ZpZXdz" title="https://github.com/shekhargulati/todoapp-spark/tree/master/src/main/resources/public/views">Github repository<i class="fa fa-external-link"></i></span>.</p>
<h2>Step 11: Run the application</h2>
<p>You can either run the application using your IDE or package this application as an executable jar and then run it from the command-line. Add the following plugin to your project pom.xml to create an executable JAR. This plugin provides the capability to package the artifact in an uber-jar, including its dependencies and to shade &#8211; i.e. rename &#8211; the packages of some of the dependencies.</p>
<div class="geshifilter">
<pre class="text geshifilter-text" style="font-family: monospace;">&lt;build&gt;
        &lt;plugins&gt;
            &lt;plugin&gt;
                &lt;groupId&gt;org.apache.maven.plugins&lt;/groupId&gt;
                &lt;artifactId&gt;maven-shade-plugin&lt;/artifactId&gt;
                &lt;version&gt;2.3&lt;/version&gt;
                &lt;configuration&gt;
                    &lt;createDependencyReducedPom&gt;true&lt;/createDependencyReducedPom&gt;
                    &lt;filters&gt;
                        &lt;filter&gt;
                            &lt;artifact&gt;*:*&lt;/artifact&gt;
                            &lt;excludes&gt;
                                &lt;exclude&gt;META-INF/*.SF&lt;/exclude&gt;
                                &lt;exclude&gt;META-INF/*.DSA&lt;/exclude&gt;
                                &lt;exclude&gt;META-INF/*.RSA&lt;/exclude&gt;
                            &lt;/excludes&gt;
                        &lt;/filter&gt;
                    &lt;/filters&gt;
                &lt;/configuration&gt;
                &lt;executions&gt;
                    &lt;execution&gt;
                        &lt;phase&gt;package&lt;/phase&gt;
                        &lt;goals&gt;
                            &lt;goal&gt;shade&lt;/goal&gt;
                        &lt;/goals&gt;
                        &lt;configuration&gt;
                            &lt;transformers&gt;
                                &lt;transformer
                                        implementation="org.apache.maven.plugins.shade.resource.ManifestResourceTransformer"&gt;
                                    &lt;mainClass&gt;com.todoapp.Bootstrap&lt;/mainClass&gt;
                                &lt;/transformer&gt;
                            &lt;/transformers&gt;
                        &lt;/configuration&gt;
                    &lt;/execution&gt;
                &lt;/executions&gt;
            &lt;/plugin&gt;
        &lt;/plugins&gt;
&lt;/build&gt;</pre>
</div>
<p>To create an executable jar, run the mvn clean install command. This creates a todoapp-1.0-SNAPSHOT.jar in the target directory.</p>
<p>To run the application:</p>
<div class="geshifilter">
<pre class="text geshifilter-text" style="font-family: monospace;">$ java -jar target/todoapp-1.0-SNAPSHOT.jar</pre>
</div>
<p>This would print following lines in the terminal.</p>
<div class="geshifilter">
<pre class="text geshifilter-text" style="font-family: monospace;">== Spark has ignited ...
>&gt; Listening on localhost:8080
[Thread-2] INFO org.eclipse.jetty.server.Server - jetty-9.0.z-SNAPSHOT
[Thread-2] INFO org.eclipse.jetty.server.ServerConnector - Started ServerConnector@5bbf3bfb{HTTP/1.1}{localhost:8080}</pre>
</div>
<h2>Step 12: Deploying on OpenShift</h2>
<p>This blog would not be complete if I didn&#8217;t show you how to run this application on OpenShift. Today OpenShift does not support JDK 8 but that doesn&#8217;t mean you can&#8217;t run Java 8 applications. You can use the DIY cartridge and install your own JDK version. The next command creates the todo application you created in the above mentioned steps. It installs JDK 8 on the DIY gear and configures other settings.</p>
<div class="geshifilter">
<pre class="text geshifilter-text" style="font-family: monospace;">$ rhc app create todoapp diy mongodb-2.4 --repo=todoapp-os --from-code=https://github.com/shekhargulati/spark-openshift-quickstart.git</pre>
</div>
<p>After this commands successfully finishes, you will see the todo app running at http://todoapp-{domain-name}.rhcloud.com. Please replace {domain-name} with your OpenShift account domain name.</p>
<h2>Next Steps</h2>
<ul>
<li><span class="exturl" data-url="aHR0cHM6Ly93d3cub3BlbnNoaWZ0LmNvbS9hcHAvYWNjb3VudC9uZXc=" title="https://www.openshift.com/app/account/new">Sign up for OpenShift Online<i class="fa fa-external-link"></i></span> and try this out yourself</li>
<li>Promote and show off your awesome app in the <span class="exturl" data-url="aHR0cHM6Ly93d3cub3BlbnNoaWZ0LmNvbS9hcHBsaWNhdGlvbi1nYWxsZXJ5" title="https://www.openshift.com/application-gallery">OpenShift Application Gallery<i class="fa fa-external-link"></i></span> today.</li>
</ul>
      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2019/06/14/practical-programming-books/src/30-minutes-to-learn-regex/" rel="next" title>
                <i class="fa fa-chevron-left"></i> 
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2019/06/14/practical-programming-books/src/android-memory-prof1/" rel="prev" title>
                 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>


  </div>


          </div>
          

  
    <div class="comments" id="gitalk-container">
    </div>

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            <!-- 添加头像链接 -->
            <a href="/about">
              
                <img class="site-author-image" itemprop="image" src="http://wx4.sinaimg.cn/orj360/e9d04169ly1fde7jy4bquj20ek0hf7gh.jpg" alt="苗沛">
              
                <p class="site-author-name" itemprop="name">苗沛</p>
            </a>
              <div class="site-description motion-element" itemprop="description">滴水石穿，不是力量大，而是功夫深!</div>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/archives/">
                
                    <span class="site-state-item-count">64</span>
                    <span class="site-state-item-name">日志</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-categories">
                  
                    
                      <a href="/categories/">
                    
                  
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">19</span>
                    <span class="site-state-item-name">分类</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-tags">
                  
                    
                      <a href="/tags/">
                    
                  
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">23</span>
                    <span class="site-state-item-name">标签</span>
                  </a>
                </div>
              
            </nav>
          

          
            <div class="feed-link motion-element">
              <a href="/atom.xml" rel="alternate">
                <i class="fa fa-rss"></i>
                RSS
              </a>
            </div>
          

          

          
            <div class="links-of-author motion-element">
              
                <span class="links-of-author-item">
                  
                  
                    
                  
                  
                    
                  
                  <span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL21pYW9wZWk=" title="GitHub &rarr; https://github.com/miaopei"><i class="fa fa-fw fa-github"></i>GitHub</span>
                </span>
              
                <span class="links-of-author-item">
                  
                  
                    
                  
                  
                    
                  
                  <a href="/miaopei163@163.com" title="E-Mail &rarr; miaopei163@163.com"><i class="fa fa-fw fa-envelope"></i>E-Mail</a>
                </span>
              
            </div>
          

          

          
          

          
            
          
          

        </div>
      </div>

      
      <!--noindex-->
        <div class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
            
            
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#undefined"><span class="nav-number">1.</span> <span class="nav-text">Application Use Case</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#undefined"><span class="nav-number">2.</span> <span class="nav-text">What is Spark?</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#undefined"><span class="nav-number">3.</span> <span class="nav-text">Prerequisite</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#undefined"><span class="nav-number">4.</span> <span class="nav-text">Github Repository</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#undefined"><span class="nav-number">5.</span> <span class="nav-text">Step 1: Create a Maven project</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#undefined"><span class="nav-number">6.</span> <span class="nav-text">Step 2: Update the maven project to use Java 8</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#undefined"><span class="nav-number">7.</span> <span class="nav-text">Step 3: Add Spark and other dependencies</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#undefined"><span class="nav-number">8.</span> <span class="nav-text">Step 4: Make Spark Say Hello World</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#undefined"><span class="nav-number">9.</span> <span class="nav-text">Step 5: Defining the Domain Model and Service class</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#undefined"><span class="nav-number">10.</span> <span class="nav-text">Step 6: Creating the Resource class</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#undefined"><span class="nav-number">11.</span> <span class="nav-text">Step 7: Bootstrap the application</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#undefined"><span class="nav-number">12.</span> <span class="nav-text">Step 8 : Setup AngularJS and Twitter Bootstrap</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#undefined"><span class="nav-number">13.</span> <span class="nav-text">Step 9: Create index.html</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#undefined"><span class="nav-number">14.</span> <span class="nav-text">Step 10: Write the Angular application</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#undefined"><span class="nav-number">15.</span> <span class="nav-text">Step 11: Run the application</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#undefined"><span class="nav-number">16.</span> <span class="nav-text">Step 12: Deploying on OpenShift</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#undefined"><span class="nav-number">17.</span> <span class="nav-text">Next Steps</span></a></li></ol></div>
            

          </div>
        </div>
      <!--/noindex-->
      

      

    </div>
  </aside>
  


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>

<div class="copyright">&copy; 2015 – <span itemprop="copyrightYear">2019</span>
  <span class="with-love" id="animate">
    <!--<i class="fa fa-user"></i>-->
    <i class="fa fa-heart" aria-hidden="true" style="color:red"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">苗沛</span>

  
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-area-chart"></i>
    </span>
    
      <span class="post-meta-item-text">站点总字数：</span>
    
    <span title="站点总字数">940k</span>
  

  
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    
      <span class="post-meta-item-text">站点阅读时长 &asymp;</span>
    
    <span title="站点阅读时长">14:14</span>
  

</div>


   <div>
   <span id="sitetime"></span>
   <span id="year" style="display:none">2016</span> 
   <span id="month" style="display:none">12</span>   
   <span id="day" style="display:none">23</span>   
   <span id="hour" style="display:none">15</span>   
   <span id="minute" style="display:none">0</span>   
   <span id="second" style="display:none">0</span>   
	<script language="javascript">
	function siteTime(){        
		window.setTimeout("siteTime()", 1000);
		var seconds = 1000;
		var minutes = seconds * 60;
		var hours = minutes * 60;
		var days = hours * 24;
		var years = days * 365;
		var today = new Date();
		var todayYear = today.getFullYear();
		var todayMonth = today.getMonth()+1;
		var todayDate = today.getDate();
		var todayHour = today.getHours();
		var todayMinute = today.getMinutes();
		var todaySecond = today.getSeconds();
		/* Date.UTC() -- 返回date对象距世界标准时间(UTC)1970年1月1日午夜之间的毫秒数(时间戳)
		year - 作为date对象的年份，为4位年份值
		month - 0-11之间的整数，做为date对象的月份
		day - 1-31之间的整数，做为date对象的天数
		hours - 0(午夜24点)-23之间的整数，做为date对象的小时数
		minutes - 0-59之间的整数，做为date对象的分钟数
		seconds - 0-59之间的整数，做为date对象的秒数
		microseconds - 0-999之间的整数，做为date对象的毫秒数 */        
		var year = document.getElementById("year").innerHTML;
		var month = document.getElementById("month").innerHTML;
		var day = document.getElementById("day").innerHTML;
		var hour = document.getElementById("hour").innerHTML;
		var minute = document.getElementById("minute").innerHTML;
		var second = document.getElementById("second").innerHTML;//北京时间2018-2-13 00:00:00
		var t1 = Date.UTC(year,month,day,hour,minute,second); 
		var t2 = Date.UTC(todayYear,todayMonth,todayDate,todayHour,todayMinute,todaySecond);
		var diff = t2-t1;
		var diffYears = Math.floor(diff/years);
		var diffDays = Math.floor((diff/days)-diffYears*365);
		var diffHours = Math.floor((diff-(diffYears*365+diffDays)*days)/hours);
		var diffMinutes = Math.floor((diff-(diffYears*365+diffDays)*days-diffHours*hours)/minutes);
		var diffSeconds = Math.floor((diff-(diffYears*365+diffDays)*days-diffHours*hours-diffMinutes*minutes)/seconds);
		if(diffYears==0){
		document.getElementById("sitetime").innerHTML=" 网站已运行 "/*+diffYears+" 年 "*/+diffDays+" 天 "+diffHours+" 小时 "+diffMinutes+" 分钟 "+diffSeconds+" 秒";
		} else{
		document.getElementById("sitetime").innerHTML=" 网站已运行 "+diffYears+" 年 "+diffDays+" 天 "+diffHours+" 小时 "+diffMinutes+" 分钟 "+diffSeconds+" 秒";
		}
	}
	//siteTime(document.getElementById("year").innerHTML,document.getElementById("year").innerHTML,document.getElementById("year").innerHTML,document.getElementById("year").innerHTML,document.getElementById("year").innerHTML,0);
	siteTime();
	</script>
</div>



<div class="powered-by">
<i class="fa fa-user-md"></i><span id="busuanzi_container_site_uv">
  本站访客数:<span id="busuanzi_value_site_uv"></span>
</span>
</div>

<!--









-->

        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>

  

  

  
</div>









        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
          <span id="scrollpercent"><span>0</span>%</span>
        
      </div>
    

    

    

    
  </div>

  

<script>
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>





  



  






  



  
    
    
  
  <script color="0,0,255" opacity="0.5" zindex="-1" count="99" src="/lib/canvas-nest/canvas-nest.min.js"></script>











  



  
  <script src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script src="/lib/fancybox/source/jquery.fancybox.pack.js"></script>

  
  <script src="/lib/reading_progress/reading_progress.js"></script>


  


  <script src="/js/utils.js?v=7.1.1"></script>

  <script src="/js/motion.js?v=7.1.1"></script>



  
  


  <script src="/js/affix.js?v=7.1.1"></script>

  <script src="/js/schemes/pisces.js?v=7.1.1"></script>




  
  <script src="/js/scrollspy.js?v=7.1.1"></script>
<script src="/js/post-details.js?v=7.1.1"></script>



  


  <script src="/js/next-boot.js?v=7.1.1"></script>


  

  
  <script src="/js/exturl.js?v=7.1.1"></script>


  
  
  

  

  
  
  


  


  
    

<script src="//cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js"></script>



<link rel="stylesheet" href="//cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.css">



<script src="//cdn.jsdelivr.net/npm/js-md5@0.7.3/src/md5.min.js"></script>

<script>
  var gitalk = new Gitalk({
    clientID: '8c7770a2f56149bd67f7',
    clientSecret: '1f8bcd6210eaf36b727bcf0546a16cb68dc9012a',
    repo: 'gitment-comments',
    owner: 'miaopei',
    admin: ['miaopei'],
    id: md5(location.pathname),
    
      language: 'zh-CN',
    
    distractionFreeMode: 'true'
  });
  gitalk.render('gitalk-container');
</script>

  


  
  <script>
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url).replace(/\/{2,}/g, '/');
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x"></i></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x"></i></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  
  

  
  

  
    
      <script type="text/x-mathjax-config">
  

  MathJax.Hub.Config({
    tex2jax: {
      inlineMath: [ ['$', '$'], ['\\(', '\\)'] ],
      processEscapes: true,
      skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
    },
    TeX: {
      
      equationNumbers: {
        autoNumber: 'AMS'
      }
    }
  });
  MathJax.Hub.Register.StartupHook('TeX Jax Ready', function() {
    MathJax.InputJax.TeX.prefilterHooks.Add(function(data) {
      if (data.display) {
        var next = data.script.nextSibling;
        while (next && next.nodeName.toLowerCase() === '#text') { next = next.nextSibling }
        if (next && next.nodeName.toLowerCase() === 'br') { next.parentNode.removeChild(next) }
      }
    });
  });
</script>

<script type="text/x-mathjax-config">
  MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for (i = 0; i < all.length; i += 1) {
      document.getElementById(all[i].inputID + '-Frame').parentNode.className += ' has-jax';
    }
  });
</script>
<script src="//cdn.jsdelivr.net/npm/mathjax@2/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

    
  


  

  
<script>
if ($('body').find('pre.mermaid').length) {
  $.ajax({
    type: 'GET',
    url: '//cdn.jsdelivr.net/npm/mermaid@8/dist/mermaid.min.js',
    dataType: 'script',
    cache: true,
    success: function() {
      mermaid.initialize({
        theme: 'forest',
        logLevel: 3,
        flowchart: { curve: 'linear' },
        gantt: { axisFormat: '%m/%d/%Y' },
        sequence: { actorMargin: 50 }
      });
    }
  });
}
</script>


  
  <script>
    (function(){
      var bp = document.createElement('script');
      var curProtocol = window.location.protocol.split(':')[0];
      bp.src = (curProtocol === 'https') ? 'https://zz.bdstatic.com/linksubmit/push.js' : 'http://push.zhanzhang.baidu.com/push.js';
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(bp, s);
    })();
  </script>


  

  

  

  
  
  
  <script src="/lib/pangu/dist/pangu.min.js?v=3.3"></script>
  <script>pangu.spacingPage();</script>


  

  
<script>
  $('.highlight').not('.gist .highlight').each(function(i, e) {
    var $wrap = $('<div>').addClass('highlight-wrap');
    $(e).after($wrap);
    $wrap.append($('<button>').addClass('copy-btn').append('复制').on('click', function(e) {
      var code = $(this).parent().find('.code').find('.line').map(function(i, e) {
        return $(e).text();
      }).toArray().join('\n');
      var ta = document.createElement('textarea');
      var yPosition = window.pageYOffset || document.documentElement.scrollTop;
      ta.style.top = yPosition + 'px'; // Prevent page scroll
      ta.style.position = 'absolute';
      ta.style.opacity = '0';
      ta.readOnly = true;
      ta.value = code;
      document.body.appendChild(ta);
      ta.select();
      ta.setSelectionRange(0, code.length);
      ta.readOnly = false;
      var result = document.execCommand('copy');
      
        if (result) $(this).text('复制成功');
        else $(this).text('复制失败');
      
      ta.blur(); // For iOS
      $(this).blur();
    })).on('mouseleave', function(e) {
      var $b = $(this).find('.copy-btn');
      setTimeout(function() {
        $b.text('复制');
      }, 300);
    }).append(e);
  })
</script>


  

  


  <!-- 页面点击小红心 -->
  <script type="text/javascript" src="/js/src/love.js"></script><!-- hexo-inject:begin --><!-- Begin: Injected MathJax -->
<script type="text/x-mathjax-config">
  MathJax.Hub.Config("");
</script>

<script type="text/x-mathjax-config">
  MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for(i=0; i < all.length; i += 1) {
      all[i].SourceElement().parentNode.className += ' has-jax';
    }
  });
</script>

<script type="text/javascript" src>
</script>
<!-- End: Injected MathJax -->
<!-- hexo-inject:end -->
</body>
</html>
